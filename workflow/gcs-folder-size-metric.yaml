#{
#  "config": {
#    "metricProject": "my-custom-monitoring-project-id"
#  },
#  "targets": {
#    "my-custom-project-for-dev": {
#      "some-storage-bucket-name": [
#        "lets_monitor_this_folder",
#        "also_this_folder/but_only_this_subfolder"
#      ]
#    }
#  }
#}

main:
  params: [args]
  steps:
    - assignVariables:
        assign:
          - metricProject: ${args.config.metricProject}
    - loopOverBuckets:
        for:
          value: projectId
          in: ${keys(args.targets)}
          steps:
            - logProjectId:
                call: sys.log
                args:
                  data: ${"Processing project " + projectId}
                  severity: WARNING
            - logBucketNames:
                call: sys.log
                args:
                  data: ${map.get(args.targets,projectId)}
                  severity: WARNING
            - parseBuckets:
                for:
                  value: bucketName
                  in: ${keys(map.get(args.targets,projectId))}
                  steps:
                    - logPaths:
                        call: sys.log
                        args:
                          data: ${args.targets[projectId][bucketName]}
                          severity: WARNING
                    - scanPaths:
                        steps:
                          - loopOverPaths:
                              for:
                                value: path
                                in: ${args.targets[projectId][bucketName]}
                                steps:
                                  - initializeTotalSize:
                                      assign:
                                        - totalSize: 0
                                  - listObjects:
                                      call: list_objects
                                      args:
                                        bucketName: ${bucketName}
                                        path: ${path}
                                        pageToken: null
                                        totalSize: ${totalSize}
                                      result: totalSize
                                  - writeMetricData:
                                      call: http.post
                                      args:
                                        url: ${"https://monitoring.googleapis.com/v3/projects/" + metricProject + "/timeSeries"}
                                        auth:
                                          type: OAuth2
                                          scopes: https://www.googleapis.com/auth/monitoring.write
                                        headers:
                                          "Content-Type": "application/json"
                                        body:
                                          timeSeries:
                                            - metric:
                                                type: "custom.googleapis.com/storage/folder_size_bytes"
                                                labels:
                                                  bucket: ${bucketName}
                                                  path: ${path}
                                                  project: ${projectId}
                                              resource:
                                                type: 'global'
                                              metricKind: "GAUGE"
                                              valueType: "INT64"
                                              points:
                                                - interval:
                                                    endTime: ${time.format(sys.now())}
                                                  value:
                                                    int64Value: ${totalSize}
                                      result: writeResult
    - theEnd:
        return: 'Done'

list_objects:
  params: [bucketName, path, pageToken, totalSize]
  steps:
    - listObjects:
        call: googleapis.storage.v1.objects.list
        args:
          bucket: ${bucketName}
          prefix: ${path}
          pageToken: ${pageToken}
          maxResults: 10
        result: objectsList
    - processItemsIfAny:
        switch:
          - condition: ${objectsList.items != null}
            steps:
              - processItems:
                  for:
                    value: item
                    in: ${objectsList.items}
                    steps:
                      - addItemSize:
                          assign:
                            - totalSize: ${totalSize + int(item.size)}
    - checkNextPageToken:
        switch:
          - condition: ${"nextPageToken" in objectsList}
            steps:
              - recurse:
                  call: list_objects
                  args:
                    bucketName: ${bucketName}
                    path: ${path}
                    pageToken: ${objectsList.nextPageToken}
                    totalSize: ${totalSize}
                  result: totalSize
    - returnTotalSize:
        return: ${totalSize}
